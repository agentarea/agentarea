# Agent Orchestrator

Оркестратор агентов - это интеллектуальная система, которая координирует работу нескольких специализированных агентов для выполнения сложных бизнес-задач. Система построена на основе LangChain и использует LLM для принятия решений о маршрутизации задач.

## Основные возможности

- Прием и обработка задач и событий через Kafka
- Сохранение контекста выполнения задач в PostgreSQL
- Динамическое определение следующего шага в процессе выполнения задачи
- Делегирование подзадач специализированным агентам через API
- Отслеживание прогресса выполнения задач
- Поддержка асинхронной обработки событий

## Архитектура

### Компоненты системы

1. **Оркестратор (orchestrator.py)**
   - Основной компонент, принимающий решения о маршрутизации задач
   - Использует LLM для анализа контекста и выбора следующего шага
   - Координирует работу специализированных агентов

2. **Kafka Consumer (kafka_consumer.py)**
   - Получает сообщения из Kafka
   - Поддерживает два типа топиков: tasks и events
   - Обеспечивает асинхронную обработку сообщений

3. **Database Manager (db/models.py)**
   - Управляет сохранением и получением контекста задач
   - Использует PostgreSQL для персистентного хранения данных
   - Поддерживает версионность контекста через timestamps

4. **Agent Tools (tools/agent_tools.py)**
   - Набор инструментов для взаимодействия с другими агентами
   - Поддерживает получение списка доступных агентов
   - Обеспечивает выполнение задач через API агентов

### Формат сообщений

#### Входящие сообщения (Kafka)

```json
{
    "task_id": "unique-task-id",  // Опционально, генерируется UUID если не указан
    "task_description": "Описание бизнес-задачи",
    "required_fields": ["field1", "field2"],  // Необходимые поля для завершения задачи
    "event_data": {
        "key": "value"  // Дополнительные данные для контекста
    }
}
```

#### Контекст задачи (PostgreSQL)

```json
{
    "id": 1,
    "task_id": "unique-task-id",
    "context": {
        "required_fields": ["field1", "field2"],
        "current_state": "processing",
        "collected_data": {}
    },
    "created_at": "2024-03-15T10:00:00Z",
    "updated_at": "2024-03-15T10:05:00Z"
}
```

## Установка и запуск

### Предварительные требования

- Python 3.9+
- Poetry
- PostgreSQL
- Apache Kafka
- OpenAI API ключ

### Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd agent-orchestrator
```

2. Установите зависимости:
```bash
poetry install
```

3. Создайте файл .env:
```bash
OPENAI_API_KEY=your-api-key
DATABASE_URL=postgresql://user:password@localhost:5432/orchestrator
```

### Запуск

1. Убедитесь, что Kafka и PostgreSQL запущены

2. Запустите оркестратор:
```bash
poetry run python orchestrator.py
```

## Процесс работы

1. Оркестратор получает сообщение из Kafka
2. Загружает существующий контекст задачи из БД (если есть)
3. Анализирует текущее состояние и определяет следующий шаг
4. При необходимости делегирует подзадачу специализированному агенту
5. Обновляет контекст в БД
6. Повторяет процесс, пока задача не будет выполнена

## Мониторинг и отладка

- Все важные события логируются с использованием стандартного модуля logging
- Состояние задач можно отслеживать через записи в БД
- Поддерживается verbose режим для агента LangChain

## Расширение функциональности

### Добавление нового агента

1. Реализуйте API агента
2. Добавьте спецификацию агента в систему
3. Обновите промпт оркестратора для учета новых возможностей

### Добавление нового типа событий

1. Определите структуру события
2. Обновите обработчик сообщений в оркестраторе
3. Добавьте необходимую логику обновления контекста

## Ограничения

- Требуется стабильное подключение к OpenAI API
- Зависимость от доступности Kafka и PostgreSQL
- Синхронная обработка сообщений в рамках одной задачи

## Планы развития

- [ ] Добавление поддержки параллельного выполнения подзадач
- [ ] Реализация механизма отката при ошибках
- [ ] Добавление метрик и мониторинга
- [ ] Поддержка различных LLM провайдеров
- [ ] Реализация механизма приоритезации задач
```
